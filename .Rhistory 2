time_cases = c(0:(length(date_dx)-1)),
var_outcome = "ICU",
var_resultado = "UCI")
# Observations with ventilator
vent_data_nal <- ssa_covid %>%
mutate(country = "Mexico",
state = "Mexico",
county = "Mexico",
pais = "México",
entidad = "Nacional",
municipio = "Nacional") %>%
group_by(country, state, county, pais, entidad, municipio, date_dx) %>%
summarise(new_cases = sum(vent_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Ventilator",
var_resultado = "Intubados")
# Deaths
deaths_data_nal <- ssa_covid %>%
mutate(country = "Mexico",
state = "Mexico",
county = "Mexico",
pais = "México",
entidad = "Nacional",
municipio = "Nacional") %>%
filter(!is.na(date_dead)) %>%
group_by(country, state, county, pais, entidad, municipio, date_dead) %>%
summarise(new_cases = sum(dead_ind)) %>%
complete(date_dead = seq.Date(min(date_dead), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dead)-1)),
var_outcome = "Deaths",
var_resultado = "Muertes")
# Number of tests
tests_data_nal <- ssa_data %>%
# filter(date_dx != "1969-12-31") %>%  # Esta es la línea que agregué para omitir la observación con esta fecha
mutate(country = "Mexico",
state = "Mexico",
county = "Mexico",
pais = "México",
entidad = "México",
municipio = "México") %>%
group_by(country, state, county, pais, entidad, municipio, date_dx) %>%
summarise(new_cases = sum(test_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Tests",
var_resultado = "Pruebas")
# Just to double check we got the right numbers in everything
sum(sx_data_nal$new_cases)
sum(dx_data_nal$new_cases)
sum(hosp_data_nal$new_cases)
sum(icu_data_nal$new_cases)
sum(vent_data_nal$new_cases)
sum(deaths_data_nal$new_cases)
sum(tests_data_nal$new_cases)
# Count number of observations
dim(sx_data_nal)
dim(dx_data_nal)
dim(hosp_data_nal)
dim(icu_data_nal)
dim(vent_data_nal)
dim(deaths_data_nal)
dim(tests_data_nal)
#------------------------------------------------#
####      Append data and add population      ####
#------------------------------------------------#
# Symptomatic observations
sx_full <- sx_data %>%
bind_rows(sx_data_nal) %>%
rename(date = date_sx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# Confirmed observations
dx_full <- dx_data %>%
bind_rows(dx_data_nal) %>%
rename(date = date_dx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# Hospitalized observations
hosp_full <- hosp_data %>%
bind_rows(hosp_data_nal) %>%
rename(date = date_dx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# ICU observations
icu_full <- icu_data %>%
bind_rows(icu_data_nal) %>%
rename(date = date_dx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# Observations with ventilator
vent_full <- vent_data %>%
bind_rows(vent_data_nal) %>%
rename(date = date_dx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# Deaths
deaths_full <- deaths_data %>%
bind_rows(deaths_data_nal) %>%
rename(date = date_dead) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
# Number of tests
tests_full <- tests_data %>%
bind_rows(tests_data_nal) %>%
rename(date = date_dx) %>%
left_join(df_pop_state_2020,
by = c("state" = "state")) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population, date,
new_cases, cum_cases, time_cases)
#--------------------------------------------#
####    Final data set for the states     ####
#--------------------------------------------#
# Append all 7 complete data sets
df_covid_ssa_state <- sx_full %>%
bind_rows(dx_full) %>%
bind_rows(hosp_full) %>%
bind_rows(icu_full) %>%
bind_rows(vent_full) %>%
bind_rows(deaths_full) %>%
bind_rows(tests_full)
#------------------------------------------------------------------#
#------------------------------------------------------------------#
#----------------------------------------------#
#### Paste counties and population for ZMVM ####
#----------------------------------------------#
df_pop_county <- df_pop_county %>%
mutate(county_id = as.numeric(county_id))
ssa_covid <- ssa_covid %>%
mutate(county_id = formatC(MUNICIPIO_RES, width = 3, flag = "0"),
state_id = formatC(ENTIDAD_RES, width = 2, flag = "0"),
county_id = paste0(state_id, county_id),
county_id= as.numeric(county_id)) %>%
left_join(df_pop_county, by = c("county_id" = "county_id")) %>%
rename(entidad = "entidad.x")
ssa_data <- ssa_data %>%
mutate(county_id = formatC(MUNICIPIO_RES, width = 3, flag = "0"),
state_id = formatC(ENTIDAD_RES, width = 2, flag = "0"),
county_id = paste0(state_id, county_id),
county_id= as.numeric(county_id)) %>%
left_join(df_pop_county, by = c("county_id" = "county_id")) %>%
rename(entidad = "entidad.x")
#--------------------------------------------#
####       Create the ZMVM category       ####
#--------------------------------------------#
# Acronyms:
# Zona Metropolitana del Valle de México (ZMVM)
# Mexico City Metropolitan Area (MCMA)
# Vector of ZMVM  county ids
v_zmvm_id <- c("9002", "9003", "9004", "9005", "9006",
"9007", "9008", "9009", "9010", "9011",
"9012", "9013", "9014", "9015", "9016",
"9017", "13069",
"15002", "15009", "15010", "15011",
"15013", "15015", "15016", "15017",
"15020", "15022", "15023", "15024",
"15025", "15028", "15029", "15030",
"15031", "15033", "15034", "15035",
"15036", "15037", "15038", "15039",
"15044", "15046", "15050", "15053",
"15057", "15058", "15059", "15060",
"15061", "15065", "15068", "15069",
"15070", "15075", "15081", "15083",
"15084", "15089", "15091", "15092",
"15093", "15094", "15095", "15096",
"15099", "15100", "15103", "15104",
"15108", "15109", "15112", "15120",
"15121", "15122", "15125")
# Create dummy for each county in ZMVM and get a subset of the
# data for ZMVM only
ssa_covid_ZMVM <- ssa_covid %>%
mutate(zmvm = ifelse(county_id %in% v_zmvm_id, 1, 0)) %>%
filter(zmvm == 1) %>%
mutate(entidad = case_when(zmvm == 1 ~ "ZMVM"),
state = case_when(zmvm == 1 ~ "MCMA"),
county_name_esp = case_when(zmvm == 1 ~ "ZMVM"),
county_name_eng = case_when(zmvm == 1 ~ "MCMA"))
ssa_data_ZMVM <- ssa_data %>%
mutate(zmvm = ifelse(county_id %in% v_zmvm_id, 1, 0)) %>%
filter(zmvm == 1) %>%
mutate(entidad = case_when(zmvm == 1 ~ "ZMVM"),
state = case_when(zmvm == 1 ~ "MCMA"),
county_name_esp = case_when(zmvm == 1 ~ "ZMVM"),
county_name_eng = case_when(zmvm == 1 ~ "MCMA"))
# Compare population
sum(unique(ssa_covid_ZMVM$population))
sum(unique(ssa_data_ZMVM$population))
#------------------------------------------------#
####           Add ZMVM population            ####
#------------------------------------------------#
df_pop_ZMVM <- df_pop_ZMVM %>%
select(entidad, population)
ssa_covid_ZMVM <- ssa_covid_ZMVM %>%
left_join(df_pop_ZMVM, by = "entidad") %>%
rename(population = "population.y")
ssa_data_ZMVM <- ssa_data_ZMVM %>%
left_join(df_pop_ZMVM, by = "entidad") %>%
rename(population = "population.y")
#------------------------------------------------#
####      ZMVM data for output variables      ####
#------------------------------------------------#
# Symptomatic observations
sx_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_sx) %>%
summarise(new_cases = sum(covid)) %>%
complete(date_sx = seq.Date(min(date_sx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_sx)-1)),
var_outcome = "Symptoms",
var_resultado = "Síntomas")
# Confirmed observations
dx_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dx) %>%
summarise(new_cases = sum(covid)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Confirmed",
var_resultado = "Confirmados")
# Hospitalized observations
hosp_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dx) %>%
summarise(new_cases = sum(hosp_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Hospitalized",
var_resultado = "Hospitalizados")
# ICU observations
icu_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dx) %>%
summarise(new_cases = sum(icu_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "ICU",
var_resultado = "UCI")
# Observations with ventilator
vent_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dx) %>%
summarise(new_cases = sum(vent_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Ventilator",
var_resultado = "Intubados")
# Deaths
deaths_data_ZMVM <- ssa_covid_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
filter(!is.na(date_dead)) %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dead) %>%
summarise(new_cases = sum(dead_ind)) %>%
complete(date_dead = seq.Date(min(date_dead), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dead)-1)),
var_outcome = "Deaths",
var_resultado = "Muertes")
# Number of tests
tests_data_ZMVM <- ssa_data_ZMVM %>%
mutate(country = "Mexico",
state = "MCMA",
county = "MCMA",
pais = "México",
entidad = "ZMVM",
municipio = "ZMVM") %>%
group_by(country, state, county, pais, entidad, municipio, population, date_dx) %>%
summarise(new_cases = sum(test_ind)) %>%
complete(date_dx = seq.Date(min(date_dx), max_date, by="day"), # Create a sequence of dates
fill = list(new_cases = 0)) %>% # Fill the dates without cases with zero
mutate(cum_cases = cumsum(new_cases),
time_cases = c(0:(length(date_dx)-1)),
var_outcome = "Tests",
var_resultado = "Pruebas")
#------------------------------------------------#
####  Clean and arrange data to be appended   ####
#------------------------------------------------#
# Symptomatic observations
sx_ZMVM <- sx_data_ZMVM %>%
rename(date = date_sx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# Confirmed observations
dx_ZMVM <- dx_data_ZMVM %>%
rename(date = date_dx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# Hospitalized observations
hosp_ZMVM <- hosp_data_ZMVM %>%
rename(date = date_dx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# ICU observations
icu_ZMVM <- icu_data_ZMVM %>%
rename(date = date_dx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# Observations with ventilator
vent_ZMVM <- vent_data_ZMVM %>%
rename(date = date_dx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# Deaths
deaths_ZMVM <- deaths_data_ZMVM %>%
rename(date = date_dead) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
# Number of tests
tests_ZMVM <- tests_data_ZMVM %>%
rename(date = date_dx) %>%
select(country, state, county, pais, entidad, municipio,
var_outcome, var_resultado, population,
date, new_cases, cum_cases, time_cases)
#--------------------------------------------#
####     Final data set for ZMVM          ####
#--------------------------------------------#
# Append all 7 complete data sets
df_covid_ssa_ZMVM <- sx_ZMVM %>%
bind_rows(dx_ZMVM) %>%
bind_rows(hosp_ZMVM) %>%
bind_rows(icu_ZMVM) %>%
bind_rows(vent_ZMVM) %>%
bind_rows(deaths_ZMVM) %>%
bind_rows(tests_ZMVM)
#------------------------------------------------------------------#
#------------------------------------------------------------------#
dim(df_covid_ssa_ZMVM)
#--------------------------------------------#
####  Final data set for states and ZMVM  ####
#--------------------------------------------#
df_covid_ssa_state <- df_covid_ssa_state %>%
bind_rows(df_covid_ssa_ZMVM)
# Add date stamp to data set
#df_covid_ssa_state$time_stamp <- Sys.Date()
df_covid_ssa_state$time_stamp <- "2020-06-29"
#--------------------------------------------#
####               Save data              ####
#--------------------------------------------#
# # Save complete and most updated data file
save(df_covid_ssa_state,
file = "data/state/df_covid_ssa_state.Rdata")
# # # Save file in csv format
write.csv(df_covid_ssa_state, paste0("data/state/covid_ssa_state_",Sys.Date(),".csv"),
row.names = FALSE)
# write.csv(df_covid_ssa_state, "data/state/covid_ssa_state_2020-07-29.csv",
#        row.names = FALSE)
# Another option to save the file (just in case accents are not shown)
#write.table(df_covid_ssa_state, paste0("data/state/covid_ssa_state_",Sys.Date(),".csv"),
#  row.names = FALSE, sep = ",")
#--------------------------------------------#
####             Libraries                ####
#--------------------------------------------#
library("XLConnect")
#--------------------------------------------#
####             Read xlsx                ####
#--------------------------------------------#
wb <- loadWorkbook("data-validation/bitacora_historica_datos_abiertos.xlsx")
date <- Sys.Date()
#date <- as.Date("2020-07-29")
date <- format(date, format="%Y-%m-%d")
#Confirmados, Negativos y Sospechosos
resultado <- table(ssa$RESULTADO)
resultado <- as.vector(resultado)
confirmados <- resultado[1]
negativos <- resultado[2]
sospechosos <- resultado[3]
#Hospitalizados
indicator_hosp <- table(ssa_covid$TIPO_PACIENTE) # 2 = hospitalizado
indicator_hosp <- as.vector(indicator_hosp)
hospitalizados <- indicator_hosp[2]
#Porcentaje hospitalizados
perc_hosp <- (hospitalizados / confirmados) * 100
table(ssa_covid$hosp_ind) # check if %hosp = hosp_ind/covid
#UCI
indicator_uci <- table(ssa_covid$UCI)# 1 = sí
indicator_uci <- as.vector(indicator_uci)
uci <- indicator_uci[1]
#Check UCI
table(ssa_covid$icu_ind)
#Intubado
indicator_intu <- table(ssa_covid$INTUBADO) # 1 = sí
indicator_intu <- as.vector(indicator_intu)
intubados <- indicator_intu[1]
#Check intubados
table(ssa_covid$vent_ind)
#Dead
indicator_deaths <- table(ssa_covid$dead_ind) # Has to be the same as the official report
indicator_deaths <- as.vector(indicator_deaths)
deaths <- indicator_deaths[2]
#Pruebas en base
tests <- sum(tests_data$new_cases)
#Confirmados
ifelse(sum(dx_data$new_cases) == confirmados,"COINCIDE", "NO COINCIDE")
#Hospitalizados
ifelse(sum(hosp_data$new_cases) == hospitalizados, "COINCIDE", "NO COINCIDE")
#UCI
ifelse(sum(icu_data$new_cases) == uci, "COINCIDE", "NO COINCIDE")
#Intubados
ifelse(sum(vent_data$new_cases) == intubados, "COINCIDE", "NO COINCIDE" )
#Muertes
ifelse(sum(deaths_data$new_cases) == deaths,"COINCIDE", "NO COINCIDE" )
#Tests
ifelse(sum(tests_data$new_cases) == tests,"COINCIDE", "NO COINCIDE" )
#--------------------------------------------#
####Create Data Frame and append new data ####
#--------------------------------------------#
data_fr <- data.frame(date,
confirmados = sum(dx_data$new_cases),
negativos,
sospechosos,
deaths = sum(deaths_data$new_cases),
perc_hosp,
hospitalizados = sum(hosp_data$new_cases),
uci = sum(icu_data$new_cases),
intubados = sum(vent_data$new_cases),
tests = sum(tests_data$new_cases))
appendWorksheet(wb, data_fr, sheet = 1)
saveWorkbook(wb)
#--------------------------------------------#
####   Fill the notebook  ####
#--------------------------------------------#
table(ssa_covid$date_dx)
table(ssa_covid$date_sx)
table(ssa_covid$date_dead)
# Count number of observations
dim(sx_data)
dim(dx_data)
dim(hosp_data)
dim(icu_data)
dim(vent_data)
dim(deaths_data)
dim(tests_data)
# Count number of observations
dim(sx_data_nal)
dim(dx_data_nal)
dim(hosp_data_nal)
dim(icu_data_nal)
dim(vent_data_nal)
dim(deaths_data_nal)
dim(tests_data_nal)
dim(df_covid_ssa_ZMVM)
